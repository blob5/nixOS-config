// Niri base configuration file
// This file contains all static configuration that doesn't change per host

// Environment variables for better Wayland support
environment {
    CLUTTER_BACKEND "wayland"
    GDK_BACKEND "wayland,x11"
    MOZ_ENABLE_WAYLAND "1"
    NIXOS_OZONE_WL "1"
    QT_QPA_PLATFORM "wayland;xcb"
    QT_WAYLAND_DISABLE_WINDOWDECORATION "1"
    SDL_VIDEODRIVER "wayland"
}

// Base input configuration (keyboard and mouse settings will be added by Nix module)
input {
    touchpad {
        tap
        dwt
        dwtp
        natural-scroll
        click-method "clickfinger"
        scroll-method "two-finger"
        tap-button-map "left-right-middle" 
        middle-emulation
        accel-profile "adaptive"
    }
    focus-follows-mouse
    warp-mouse-to-focus
    workspace-auto-back-and-forth
}

// Layout configuration with improved aesthetics
layout {
    gaps 6
    center-focused-column "never"
    
    preset-column-widths {
        proportion 0.25
        proportion 0.33333
        proportion 0.5
        proportion 0.66667
        proportion 0.75
    }
    default-column-width { proportion 0.5; }
    
    focus-ring {
        enable false
    }
    
    border {
        enable true
        width 1
        active {
            gradient {
                angle 45
                from "#7fc8e8"
                to "#94e2d5"
            }
        }
        inactive {
            color "#2a2e2a"
        }
    }
    
    shadow {
        enable true
        color "#00000020"
        blur-sigma 8.0
        spread 2.0
        offset {
            x 0
            y 4
        }
    }
    
    struts {
        left 0
        right 0
        top 0
        bottom 0
    }
}

// Comprehensive window rules for better UX
window-rule {
    geometry-corner-radius {
        bottom-left 12.0
        bottom-right 12.0
        top-left 12.0
        top-right 12.0
    }
    clip-to-geometry true
    draw-border-with-background false
}

window-rule {
    match is-floating=true
    shadow {
        enable true
        color "#00000040"
        blur-sigma 12.0
        spread 4.0
    }
}

// Privacy: block screencasting for messaging apps
window-rule {
    matches app-id="org.telegram.desktop" app-id="app.drey.PaperPlane" app-id="vesktop" app-id="discord"
    block-out-from "screencast"
}

// Better defaults for browsers
window-rule {
    matches app-id="firefox" app-id="zen" app-id="chromium-browser" app-id="google-chrome"
    default-column-width { proportion 0.7; }
    scroll-factor 0.3
}

// Maximize productivity apps
window-rule {
    matches app-id="zen" app-id="obsidian" app-id="code" app-id="vesktop"
    open-maximized true
}

// Picture-in-picture positioning
window-rule {
    matches app-id="firefox" title="Picture-in-Picture"
    open-floating true
    default-floating-position {
        x 32
        y 32
        relative-to "bottom-right"
    }
    default-column-width { fixed 480; }
    default-window-height { fixed 270; }
}

window-rule {
    matches app-id="zen" title="Picture-in-Picture"
    open-floating true
    default-floating-position {
        x 32
        y 32
        relative-to "bottom-right"
    }
    default-column-width { fixed 480; }
    default-window-height { fixed 270; }
}

window-rule {
    matches title="Picture in picture" title="Discord Popout"
    open-floating true
    default-floating-position {
        x 32
        y 32
        relative-to "bottom-right"
    }
}

// System dialogs and utilities
window-rule {
    matches app-id="pavucontrol" app-id="pavucontrol-qt" app-id="com.saivert.pwvucontrol" app-id="blueman-manager" app-id="nm-connection-editor" app-id="file-roller" app-id="org.gnome.FileRoller" app-id="gcr-prompter" app-id="org.kde.polkit-kde-authentication-agent-1" app-id="pinentry"
    open-floating true
}

window-rule {
    matches title="Progress" title="File Operations" title="Properties" title="Authentication Required" title="Copying" title="Moving" title="Downloads" title="Confirm" title="Notice" title="Warning" title="Error"
    open-floating true
}

// Spawn at startup
spawn-at-startup "polkit-gnome-authentication-agent-1"
spawn-at-startup "swww-daemon"
spawn-at-startup "waybar"
spawn-at-startup "wl-paste" "--type" "text"
spawn-at-startup "wl-paste" "--type" "image"
spawn-at-startup "xwayland-satellite"

// Key bindings
binds {
    // Window management
    "Mod+Q" { close-window; }
    "Mod+H" { focus-column-left; }
    "Mod+L" { focus-column-right; }
    "Mod+J" { focus-window-down; }
    "Mod+K" { focus-window-up; }
    "Mod+Shift+H" { move-column-left; }
    "Mod+Shift+L" { move-column-right; }
    "Mod+Shift+J" { move-window-down; }
    "Mod+Shift+K" { move-window-up; }
    
    // Column management
    "Mod+Comma" { consume-window-into-column; }
    "Mod+Period" { expel-window-from-column; }
    "Mod+BracketLeft" { consume-or-expel-window-left; }
    "Mod+BracketRight" { consume-or-expel-window-right; }
    
    // Column width
    "Mod+Minus" { set-column-width "-10%"; }
    "Mod+Equal" { set-column-width "+10%"; }
    "Mod+Shift+Minus" { set-window-height "-10%"; }
    "Mod+Shift+Equal" { set-window-height "+10%"; }
    
    // Workspaces
    "Mod+1" { focus-workspace 1; }
    "Mod+2" { focus-workspace 2; }
    "Mod+3" { focus-workspace 3; }
    "Mod+4" { focus-workspace 4; }
    "Mod+5" { focus-workspace 5; }
    "Mod+6" { focus-workspace 6; }
    "Mod+7" { focus-workspace 7; }
    "Mod+8" { focus-workspace 8; }
    "Mod+9" { focus-workspace 9; }
    "Mod+Shift+1" { move-column-to-workspace 1; }
    "Mod+Shift+2" { move-column-to-workspace 2; }
    "Mod+Shift+3" { move-column-to-workspace 3; }
    "Mod+Shift+4" { move-column-to-workspace 4; }
    "Mod+Shift+5" { move-column-to-workspace 5; }
    "Mod+Shift+6" { move-column-to-workspace 6; }
    "Mod+Shift+7" { move-column-to-workspace 7; }
    "Mod+Shift+8" { move-column-to-workspace 8; }
    "Mod+Shift+9" { move-column-to-workspace 9; }
    
    // Applications  
    "Mod+Return" { spawn "wezterm"; }
    "Mod+R" { spawn "rofi" "-show" "drun" "-show-icons"; }
    "Mod+E" { spawn "nautilus"; }  // Changed from dolphin to nautilus for consistency
    "Mod+B" { spawn "zen"; }
    
    // System
    "Mod+Shift+E" { quit; }
    "Mod+Shift+S" { screenshot; }
    "Print" { screenshot; }
    "Mod+Shift+R" { reload-config; }
    
    // Audio controls
    "XF86AudioRaiseVolume" { spawn "wpctl" "set-volume" "@DEFAULT_AUDIO_SINK@" "0.1+"; }
    "XF86AudioLowerVolume" { spawn "wpctl" "set-volume" "@DEFAULT_AUDIO_SINK@" "0.1-"; }
    "XF86AudioMute" { spawn "wpctl" "set-mute" "@DEFAULT_AUDIO_SINK@" "toggle"; }
    
    // Brightness controls
    "XF86MonBrightnessUp" { spawn "brightnessctl" "set" "10%+"; }
    "XF86MonBrightnessDown" { spawn "brightnessctl" "set" "10%-"; }
}

// Cursor configuration
cursor {
    theme "Adwaita"
    size 24
}

// Smooth animations for flow
animations {
    slowdown 0.8
    
    window-open {
        duration-ms 200
        curve "ease-out-cubic"
    }
    
    window-close {
        duration-ms 150
        curve "ease-in-cubic"
    }
    
    horizontal-view-movement {
        duration-ms 200
        curve "ease-out-cubic"
    }
    
    workspace-switch {
        duration-ms 200
        curve "ease-out-cubic"
    }
    
    window-movement {
        duration-ms 200
        curve "ease-out-cubic"
    }
    
    window-resize {
        duration-ms 150
        curve "ease-out-cubic"
    }

    shaders {
        window-resize "
            vec4 resize_color(vec3 coords_curr_geo, vec3 size_curr_geo) {
                vec3 coords_next_geo = niri_curr_geo_to_next_geo * coords_curr_geo;
                vec3 coords_stretch = niri_geo_to_tex_next * coords_curr_geo;
                vec3 coords_crop = niri_geo_to_tex_next * coords_next_geo;

                bool can_crop_by_x = niri_curr_geo_to_next_geo[0][0] <= 1.0;
                bool can_crop_by_y = niri_curr_geo_to_next_geo[1][1] <= 1.0;

                vec3 coords = coords_stretch;
                if (can_crop_by_x) coords.x = coords_crop.x;
                if (can_crop_by_y) coords.y = coords_crop.y;

                vec4 color = texture2D(niri_tex_next, coords.st);

                if (can_crop_by_x && (coords_curr_geo.x < 0.0 || 1.0 < coords_curr_geo.x))
                    color = vec4(0.0);
                if (can_crop_by_y && (coords_curr_geo.y < 0.0 || 1.0 < coords_curr_geo.y))
                    color = vec4(0.0);

                return color;
            }
        "
    }
}

// Screenshot configuration
screenshot-path "~/Pictures/Screenshots/Screenshot-from-%Y-%m-%d-%H-%M-%S.png"

// System preferences
prefer-no-csd true
hotkey-overlay {
    skip-at-startup true
}